---
title: "cleaning-script"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## package loading

loading in the relevant packages CRAN packages. 

```{r}
library(tidyverse)
library(ggpubr)
```


## data loading

loading in the US enrollment data from the `parent-dataset` folder

```{r}
as_tibble(read.csv("/Users/kenjinchang/github/projected-impact-model/parent-datasets/enrollment_projections.csv"))
```

performing the necessary cleaning procedures to make the parent dataset suitable for our analyses

in order, we: 

1. omit the initial two rows that correspond to (1) the title of the table and and (2) the numeric column identifiers

2. omit the degree-level percent-female variables 

3. rename the variables for brevity

4. omit the row specifying the variable ID

5. omit the source information and table notes from the tibble

6. renamed the columns dichotomously indicating whether the corresponding bachelor-level enrollment value include degrees classified as master's or doctor's degree in later years

7. changed column values within the the `bach_deg_tot_assoc`, `bach_deg_m_assoc`, and `bach_deg_f_assoc` from `\\2\\` to `1` and `0`, with `1` corresponding to enrollment totals that do incoude degrees classified as master's or doctor's degrees in later years and `0` corresponding to enrollment totals that do not

8. changed columns from character strings to numeric strings 

9. replaced `NA` values with `0` values

10. generated new columns aggregating the number of degrees earned, both as a total and across sexes, between bachelor's, master's, and doctoral programs 

11. generated new columns calculating the proportion of university degrees contributed by bachelor's, master's, and doctoral programs

12. added an identifying column (by year) for joining purposes



```{r}
enrollment_data <- as_tibble(read.csv("/Users/kenjinchang/github/projected-impact-model/parent-datasets/enrollment_projections.csv",skip=1)) %>%
  filter(!row_number() %in% c(2)) %>%
  select(!c(Associate.s.degrees.3,Bachelor.s.degrees.6,Master.s.degrees.3,Doctor.s.degrees.1..3)) %>%
  rename(acad.year=Year,assoc_deg_tot=Associate.s.degrees,assoc_deg_m=Associate.s.degrees.1,assoc_deg_f=Associate.s.degrees.2,bach_deg_tot=Bachelor.s.degrees,bach_deg_m=Bachelor.s.degrees.2,bach_deg_f=Bachelor.s.degrees.4,mast_deg_tot=Master.s.degrees,mast_deg_m=Master.s.degrees.1,mast_deg_f=Master.s.degrees.2,doct_deg_tot=Doctor.s.degrees.1.,doct_deg_m=Doctor.s.degrees.1..1,doct_deg_f=Doctor.s.degrees.1..2) %>%
  filter(!row_number() %in% c(1,66,67,68,69,70,71)) %>%
  rename(bach_deg_tot_assoc=Bachelor.s.degrees.1,bach_deg_m_assoc=Bachelor.s.degrees.3,bach_deg_f_assoc=Bachelor.s.degrees.5) %>%
  mutate(bach_deg_tot_assoc=replace(bach_deg_tot_assoc, bach_deg_tot_assoc != "\\2\\","0")) %>%
  mutate(bach_deg_tot_assoc=replace(bach_deg_tot_assoc, bach_deg_tot_assoc == "\\2\\","1")) %>%
  mutate(bach_deg_m_assoc=replace(bach_deg_m_assoc, bach_deg_m_assoc != "\\2\\","0")) %>%
  mutate(bach_deg_m_assoc=replace(bach_deg_m_assoc, bach_deg_m_assoc == "\\2\\","1")) %>%
  mutate(bach_deg_f_assoc=replace(bach_deg_f_assoc, bach_deg_f_assoc != "\\2\\","0")) %>%
  mutate(bach_deg_f_assoc=replace(bach_deg_f_assoc, bach_deg_f_assoc == "\\2\\","1")) %>%
  mutate(assoc_deg_tot=as.double(assoc_deg_tot)) %>%
  mutate(assoc_deg_m=as.double(assoc_deg_m)) %>%
  mutate(assoc_deg_f=as.double(assoc_deg_f)) %>%
  mutate(bach_deg_tot=as.double(bach_deg_tot)) %>%
  mutate(bach_deg_tot_assoc=as.double(bach_deg_tot_assoc)) %>%
  mutate(bach_deg_m=as.double(bach_deg_m)) %>%
  mutate(bach_deg_m_assoc=as.double(bach_deg_m_assoc)) %>%
  mutate(bach_deg_f=as.double(bach_deg_f)) %>%
  mutate(bach_deg_f_assoc=as.double(bach_deg_f_assoc)) %>%
  mutate(mast_deg_tot=as.double(mast_deg_tot)) %>%
  mutate(mast_deg_m=as.double(mast_deg_m)) %>%
  mutate(mast_deg_f=as.double(mast_deg_f)) %>%
  mutate(doct_deg_tot=as.double(doct_deg_tot)) %>%
  mutate(doct_deg_m=as.double(doct_deg_m)) %>%
  mutate(doct_deg_f=as.double(doct_deg_f)) %>%
  replace(is.na(.), 0) %>%
  mutate(univ_deg_tot=bach_deg_tot+mast_deg_tot+doct_deg_tot) %>%
  mutate(univ_deg_m=bach_deg_m+mast_deg_m+doct_deg_m) %>%
  mutate(univ_deg_f=bach_deg_f+mast_deg_f+doct_deg_f) %>%
  mutate(perc_bach_tot=bach_deg_tot/univ_deg_tot) %>%
  mutate(perc_mast_tot=mast_deg_tot/univ_deg_tot) %>%
  mutate(perc_doct_tot=doct_deg_tot/univ_deg_tot) %>%
  separate(acad.year,"year_id",sep="-",remove=FALSE)
enrollment_data
```

## preliminary data exploration

looking at the number of people enrolled in university over time

```{r}
ggplot(enrollment_data,aes(x=acad.year,y=univ_deg_tot)) +
  geom_col() 
```

because it's useful to see this as a function of the national population, we take census projections and estimates to highlighting how enrollment changes relative to changes in the population

this helps to illustrate the role of intervening within these contexts and how it is expected to change over time

in taking the census data, which provides projections from 2022 to 2100, we then take the following steps to clean the data in preparation for a join: 

1. omit the initial few rows containing the title of table and nonessential descriptive information

2. identify and select the relevant columns

3. properly align the rows so that each year corresponds to the correct projection

4. multiply the projection by a factor of 1000 to align the units of analysis

5. remove table footnotes 

5. rename the variables so that they are consistent with our naming conventions

```{r}
population_projections <- as_tibble(read.csv("/Users/kenjinchang/github/projected-impact-model/parent-datasets/population_projections.csv",skip=4)) %>%
  select(Year,Population) %>%
  mutate_at(c("Population"),funs(lead),n=2) %>%
  mutate(population=as.numeric(Population)*1000) %>%
  filter(!row_number() %in% c(82,83,84,85,86,87,88,89)) %>%
  rename(year_id=Year) %>%
  select(!Population)
population_projections
```

now, we use a `left_join` command to add all matching columns from the `population_projections` tibble to the `enrollment_data` tibble:

```{r}
cleaned_data <- left_join(enrollment_data,population_projections)
cleaned_data
```

